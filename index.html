import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from 'firebase/firestore';

// --- Firebase Setup ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'drum-tuner-pro';

// --- Muzikale Hulpmiddelen ---
const getNoteFromFreq = (freq) => {
  if (!freq || freq < 20) return "-";
  const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  const semitones = 12 * (Math.log(freq / 440) / Math.log(2));
  const noteIndex = Math.round(semitones) + 69;
  const name = notes[noteIndex % 12];
  const octave = Math.floor(noteIndex / 12) - 1;
  return `${name}${octave}`;
};

const App = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('tuner'); 
  const [isRunning, setIsRunning] = useState(false);
  const [currentMode, setCurrentMode] = useState('toms'); // bass, snare, toms
  const [frequency, setFrequency] = useState(0);
  const [lang, setLang] = useState('nl');
  const [selectedTomIdx, setSelectedTomIdx] = useState(0);

  // Instellingen gebaseerd op screenshot IMG_5097
  const [kitSettings, setKitSettings] = useState({
    snareTuning: 0.5,
    resoRatio: 0.5, // Gelijk
    bassSize: 22,
    snareSize: 14,
    numToms: 4,
    tomSizes: [10, 12, 14, 16],
    soundStyle: 'rock'
  });

  const audioContextRef = useRef(null);
  const analyserRef = useRef(null);
  const animationRef = useRef(null);
  const lastUpdateRef = useRef(0);

  // Auth & Sync
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const settingsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'kit');
    const unsub = onSnapshot(settingsRef, (docSnap) => {
      if (docSnap.exists()) setKitSettings(prev => ({...prev, ...docSnap.data()}));
    });
    return () => unsub();
  }, [user]);

  // Audio Engine
  const initAudio = async () => {
    if (!audioContextRef.current) {
      audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioContextRef.current.createMediaStreamSource(stream);
      const analyser = audioContextRef.current.createAnalyser();
      analyser.fftSize = 16384; 
      analyser.smoothingTimeConstant = 0.2;
      source.connect(analyser);
      analyserRef.current = analyser;
      return true;
    } catch (e) {
      return false;
    }
  };

  const processAudio = () => {
    if (!analyserRef.current) return;
    const bufferLength = analyserRef.current.frequencyBinCount;
    const dataArray = new Float32Array(bufferLength);
    analyserRef.current.getFloatFrequencyData(dataArray);

    // Bepaal zoekbereik voor "Lug Pitch"
    let minHz = 80, maxHz = 600;
    if (currentMode === 'bass') { minHz = 40; maxHz = 130; }
    if (currentMode === 'snare') { minHz = 180; maxHz = 650; }
    if (currentMode === 'toms') {
        const size = kitSettings.tomSizes[selectedTomIdx];
        minHz = size > 14 ? 70 : 130;
        maxHz = size > 14 ? 250 : 500;
    }

    const nyquist = audioContextRef.current.sampleRate / 2;
    const lowBin = Math.floor((minHz / nyquist) * bufferLength);
    const highBin = Math.ceil((maxHz / nyquist) * bufferLength);

    let peakIdx = -1;
    let peakVal = -Infinity;

    for (let i = lowBin; i < highBin; i++) {
      if (dataArray[i] > peakVal) {
        peakVal = dataArray[i];
        peakIdx = i;
      }
    }

    // Alleen updaten bij een duidelijke 'hit' (piekwaarde drempel)
    const now = Date.now();
    if (peakVal > -50 && (now - lastUpdateRef.current > 300)) {
        let freq = peakIdx * (audioContextRef.current.sampleRate / analyserRef.current.fftSize);
        // Parabolische interpolatie voor sub-Hz precisie
        if (peakIdx > 0 && peakIdx < bufferLength - 1) {
            const alpha = dataArray[peakIdx - 1];
            const beta = dataArray[peakIdx];
            const gamma = dataArray[peakIdx + 1];
            const p = 0.5 * (alpha - gamma) / (alpha - 2 * beta + gamma);
            freq = (peakIdx + p) * (audioContextRef.current.sampleRate / analyserRef.current.fftSize);
        }
        setFrequency(freq);
        lastUpdateRef.current = now;
    }

    animationRef.current = requestAnimationFrame(processAudio);
  };

  const toggleTuner = async () => {
    if (!isRunning) {
      if (await initAudio()) {
        setIsRunning(true);
        processAudio();
      }
    } else {
      setIsRunning(false);
      cancelAnimationFrame(animationRef.current);
    }
  };

  // Bereken targets (Simulatie van Tune-Bot logica)
  const getTarget = (head) => {
      let base = 188;
      if (currentMode === 'snare') base = 280;
      if (currentMode === 'bass') base = 65;
      if (currentMode === 'toms') {
          const s = kitSettings.tomSizes[selectedTomIdx];
          base = s === 10 ? 188 : s === 12 ? 155 : s === 14 ? 125 : 95;
      }
      
      if (head === 'reso') {
          // Relatie tussen slagvel en reso
          if (kitSettings.resoRatio < 0.4) return (base * 0.9).toFixed(0);
          if (kitSettings.resoRatio > 0.6) return (base * 1.1).toFixed(0);
          return base.toFixed(0);
      }
      return base.toFixed(0);
  };

  return (
    <div className="min-h-screen bg-[#0a0e1a] text-white font-sans p-4 flex flex-col items-center">
      <div className="w-full max-w-md flex flex-col h-full">
        
        {/* Header - Zoals screenshot */}
        <header className="flex justify-between items-center mb-6">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-[#2563eb] rounded-xl flex items-center justify-center shadow-lg font-black italic text-sm">Ti</div>
            <div>
              <h1 className="text-lg font-black tracking-tight uppercase leading-none">TUNE-inator</h1>
              <p className="text-[9px] font-bold tracking-[0.2em] text-[#2563eb] uppercase">{kitSettings.soundStyle} MODE</p>
            </div>
          </div>
          <button onClick={() => setView(view === 'tuner' ? 'settings' : 'tuner')} className="w-10 h-10 bg-white/5 rounded-xl flex items-center justify-center border border-white/10">
            {view === 'tuner' ? '⚙️' : '✕'}
          </button>
        </header>

        {view === 'tuner' ? (
          <div className="space-y-4 animate-in fade-in duration-500">
            
            {/* Top Cards - Slagvel & Reso (IMG_5098) */}
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-[#161b2c] border border-white/5 p-4 rounded-3xl text-center">
                <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-2">LUG PITCH - SLAGVEL</p>
                <p className="text-3xl font-black text-[#60a5fa]">{getTarget('batter')} Hz</p>
                <p className="text-[10px] font-bold text-slate-400 mt-1">{getNoteFromFreq(getTarget('batter'))}</p>
              </div>
              <div className="bg-[#161b2c] border border-white/5 p-4 rounded-3xl text-center">
                <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-2">LUG PITCH - RESO</p>
                <p className="text-3xl font-black text-[#60a5fa]">{getTarget('reso')} Hz</p>
                <p className="text-[10px] font-bold text-slate-400 mt-1">{getNoteFromFreq(getTarget('reso'))}</p>
              </div>
            </div>

            {/* Main Display (IMG_5098) */}
            <div className="bg-[#161b2c] rounded-[2.5rem] p-10 text-center relative border border-white/5 shadow-2xl">
              <div className="text-[10rem] font-black tracking-tighter leading-none tabular-nums overflow-hidden">
                {frequency > 0 ? frequency.toFixed(1) : "0.0"}
              </div>
              <div className="mt-2 h-[2px] w-24 bg-slate-800 mx-auto rounded-full" />
              <p className="text-slate-500 font-bold tracking-[0.4em] uppercase text-xs mt-4">HERTZ</p>
            </div>

            {/* Instrument Tabs */}
            <div className="grid grid-cols-3 gap-2">
              {['BASS', 'SNARE', 'TOMS'].map(m => (
                <button 
                  key={m} 
                  onClick={() => {setCurrentMode(m.toLowerCase()); setFrequency(0);}}
                  className={`py-4 rounded-2xl text-[10px] font-black tracking-widest transition-all ${currentMode === m.toLowerCase() ? 'bg-[#2563eb] text-white' : 'bg-[#161b2c] text-slate-500'}`}
                >
                  {m}
                </button>
              ))}
            </div>

            {/* Tom Bubbles (IMG_5098) */}
            {currentMode === 'toms' && (
              <div className="flex justify-center gap-3 py-2">
                {kitSettings.tomSizes.map((size, idx) => (
                  <button 
                    key={idx} 
                    onClick={() => {setSelectedTomIdx(idx); setFrequency(0);}}
                    className={`w-14 h-14 rounded-full flex flex-col items-center justify-center transition-all border-2 ${selectedTomIdx === idx ? 'bg-[#2563eb] border-white scale-110 shadow-xl' : 'bg-[#161b2c] border-white/5 text-slate-500'}`}
                  >
                    <span className="text-[11px] font-black">{size}"</span>
                    <span className="text-[7px] font-bold opacity-50">{getNoteFromFreq(getTarget('batter'))}</span>
                  </button>
                ))}
              </div>
            )}

            {/* Action Buttons */}
            <div className="flex gap-3">
              <button 
                onClick={toggleTuner}
                className="flex-[2] py-5 bg-white text-black rounded-3xl font-black text-xl shadow-xl active:scale-95 transition-all"
              >
                {isRunning ? 'STOP' : 'START'}
              </button>
              <button className="flex-1 py-5 bg-[#161b2c] text-slate-500 rounded-3xl font-black text-[10px] tracking-widest uppercase border border-white/5">
                FILTER / REF
              </button>
            </div>

            {/* Tip (IMG_5098) */}
            <div className="bg-[#fbbf24]/5 border border-[#fbbf24]/20 p-4 rounded-2xl text-center">
              <p className="text-[9px] text-[#fbbf24] font-black tracking-widest uppercase">
                SLA ZACHTJES AAN BIJ DE LUG VOOR DE BESTE METING.
              </p>
            </div>

          </div>
        ) : (
          /* Settings View - Gebaseerd op IMG_5097 */
          <div className="bg-[#161b2c] rounded-[2.5rem] p-6 space-y-8 animate-in slide-in-from-bottom duration-500 overflow-y-auto max-h-[85vh]">
            <h2 className="text-xl font-black uppercase tracking-tight">KIT INSTELLINGEN</h2>

            {/* Taal Selectie */}
            <div className="bg-[#0a0e1a] p-4 rounded-2xl flex justify-between items-center">
                <span className="text-[9px] font-black text-slate-500 uppercase tracking-widest">TAAL / LANGUAGE</span>
                <div className="flex bg-slate-800 p-1 rounded-lg">
                    <button onClick={() => setLang('nl')} className={`px-4 py-1.5 rounded-md text-[10px] font-black ${lang === 'nl' ? 'bg-[#2563eb]' : ''}`}>NL</button>
                    <button onClick={() => setLang('en')} className={`px-4 py-1.5 rounded-md text-[10px] font-black ${lang === 'en' ? 'bg-[#2563eb]' : ''}`}>EN</button>
                </div>
            </div>

            {/* Snare Karakter Slider */}
            <div className="bg-[#0a0e1a] p-5 rounded-2xl space-y-4">
                <div className="flex justify-between items-end">
                    <div>
                        <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest leading-none">SNARE KARAKTER</p>
                        <p className="text-[7px] font-bold text-slate-600 uppercase mt-1">SNARE CHARACTER</p>
                    </div>
                    <p className="text-[11px] font-black text-[#2563eb] italic uppercase">STANDARD</p>
                </div>
                <input type="range" className="w-full accent-[#2563eb]" min="0" max="1" step="0.1" value={kitSettings.snareTuning} onChange={(e) => setKitSettings({...kitSettings, snareTuning: e.target.value})} />
                <div className="flex justify-between text-[8px] font-black text-slate-600 uppercase tracking-tighter">
                    <span>THUDDY LOW</span>
                    <span>CRACKY HIGH</span>
                </div>
            </div>

            {/* Resonantie Slider */}
            <div className="bg-[#0a0e1a] p-5 rounded-2xl space-y-4">
                <div className="flex justify-between items-end">
                    <div>
                        <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest leading-none">RESONANTIE KARAKTER</p>
                        <p className="text-[7px] font-bold text-slate-600 uppercase mt-1">RELATIE TUSSEN SLAGVEL EN RESO</p>
                    </div>
                    <div className="text-right">
                        <p className="text-[11px] font-black text-[#2563eb] italic uppercase leading-none">LANGE RESO</p>
                        <p className="text-[11px] font-black text-[#2563eb] italic uppercase">(GELIJK)</p>
                    </div>
                </div>
                <input type="range" className="w-full accent-[#2563eb]" min="0" max="1" step="0.1" value={kitSettings.resoRatio} onChange={(e) => setKitSettings({...kitSettings, resoRatio: e.target.value})} />
                <div className="flex justify-between text-[8px] font-black text-slate-600 uppercase tracking-tighter">
                    <span>TOP LAGER</span>
                    <span>GELIJK</span>
                    <span>TOP HOGER</span>
                </div>
            </div>

            {/* Bass & Snare Maten */}
            <div className="grid grid-cols-2 gap-4">
                <div className="bg-[#0a0e1a] p-4 rounded-2xl">
                    <p className="text-[8px] font-black text-slate-500 uppercase mb-3">BASS (")</p>
                    <input type="number" value={kitSettings.bassSize} onChange={(e) => setKitSettings({...kitSettings, bassSize: e.target.value})} className="w-full bg-slate-800 rounded-xl p-3 text-center font-black text-xl" />
                </div>
                <div className="bg-[#0a0e1a] p-4 rounded-2xl">
                    <p className="text-[8px] font-black text-slate-500 uppercase mb-3">SNARE (")</p>
                    <input type="number" value={kitSettings.snareSize} onChange={(e) => setKitSettings({...kitSettings, snareSize: e.target.value})} className="w-full bg-slate-800 rounded-xl p-3 text-center font-black text-xl" />
                </div>
            </div>

            {/* Klank Karakter Grid */}
            <div className="space-y-3">
                <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest">KLANK KARAKTER</p>
                <div className="grid grid-cols-2 gap-2">
                    {['DRY', 'ROCK', 'JAZZ', 'METAL'].map(s => (
                        <button 
                            key={s} 
                            onClick={() => setKitSettings({...kitSettings, soundStyle: s.toLowerCase()})}
                            className={`py-4 rounded-xl text-[10px] font-black tracking-widest transition-all ${kitSettings.soundStyle === s.toLowerCase() ? 'bg-[#2563eb]' : 'bg-[#0a0e1a] text-slate-500'}`}
                        >
                            {s}
                        </button>
                    ))}
                </div>
            </div>

            <button 
                onClick={async () => {
                    if (user) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'kit'), kitSettings);
                    setView('tuner');
                }}
                className="w-full py-5 bg-white text-black rounded-3xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all mt-4"
            >
                OPSLAAN & TOEPASSEN
            </button>

          </div>
        )}
      </div>
    </div>
  );
};

export default App;
