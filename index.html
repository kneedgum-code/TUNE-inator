<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRUM TUNE-inator | Professional Drum Tuner</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0a0e1a; color: white; margin: 0; font-family: sans-serif; overflow-x: hidden; }
        .bg-dark-card { background-color: #161b2c; border: 1px solid rgba(255,255,255,0.05); }
        input[type=range] { cursor: pointer; height: 6px; -webkit-appearance: none; background: #1e293b; border-radius: 999px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #2563eb; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tare-active { color: #60a5fa; text-shadow: 0 0 10px rgba(96, 165, 250, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const translations = {
            nl: {
                targetBatter: "TARGET SLAGVEL",
                targetReso: "TARGET RESO",
                hertz: "REAL-TIME HERTZ",
                start: "START TUNER",
                stop: "STOP",
                tare: "TARE",
                reset: "RESET",
                instruction: "Sla zachtjes bij een lug voor de meest zuivere meting.",
                settings: "KIT CONFIGURATIE",
                snareTuning: "SNARE STEMMING",
                deep: "Diep / Vet",
                tight: "Strak / Crack",
                resonance: "RESONANTIE (SUSTAIN)",
                maxAttack: "Max Attack (Kort)",
                maxSustain: "Max Sustain (Lang)",
                tomConfig: "TOM CONFIGURATIE",
                save: "OPSLAAN & SLUITEN",
                language: "TAAL / LANGUAGE",
                genre: "GENRE / STIJL"
            },
            en: {
                targetBatter: "TARGET BATTER",
                targetReso: "TARGET RESO",
                hertz: "REAL-TIME HERTZ",
                start: "START TUNER",
                stop: "STOP",
                tare: "TARE",
                reset: "RESET",
                instruction: "Tap gently near a lug for the most accurate reading.",
                settings: "KIT CONFIGURATION",
                snareTuning: "SNARE TUNING",
                deep: "Deep / Fat",
                tight: "Tight / Crack",
                resonance: "RESONANCE (SUSTAIN)",
                maxAttack: "Max Attack (Short)",
                maxSustain: "Max Sustain (Long)",
                tomConfig: "TOM CONFIGURATION",
                save: "SAVE & CLOSE",
                language: "LANGUAGE / TAAL",
                genre: "GENRE / STYLE"
            }
        };

        const getNoteFromFreq = (freq) => {
            if (!freq || freq < 20) return "-";
            const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            const semitones = 12 * (Math.log(freq / 440) / Math.log(2));
            const noteIndex = Math.round(semitones) + 69;
            const name = notes[noteIndex % 12];
            const octave = Math.floor(noteIndex / 12) - 1;
            return `${name}${octave}`;
        };

        const App = () => {
            const [view, setView] = useState('tuner');
            const [isRunning, setIsRunning] = useState(false);
            const [currentMode, setCurrentMode] = useState('toms');
            const [frequency, setFrequency] = useState(0);
            const [tareValue, setTareValue] = useState(null);
            const [selectedTomIdx, setSelectedTomIdx] = useState(0);
            const [lang, setLang] = useState('nl');

            const [kitSettings, setKitSettings] = useState({
                snareTuning: 0.5,
                resoRatio: 0.5,
                bassSize: 22,
                snareSize: 14,
                numToms: 4,
                tomSizes: [10, 12, 14, 16],
                soundStyle: 'rock'
            });

            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const animationRef = useRef(null);
            const lastUpdateRef = useRef(0);

            const t = translations[lang];

            useEffect(() => {
                const saved = localStorage.getItem('tuneinator_pro_v2_genres');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setKitSettings(parsed);
                        if (parsed.lang) setLang(parsed.lang);
                    } catch(e) { console.error(e); }
                }
            }, []);

            const initAudio = async () => {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        } 
                    });
                    const source = audioContextRef.current.createMediaStreamSource(stream);
                    const analyser = audioContextRef.current.createAnalyser();
                    // Maximale resolutie voor lage drum-frequenties
                    analyser.fftSize = 32768; 
                    analyser.smoothingTimeConstant = 0.2;
                    source.connect(analyser);
                    analyserRef.current = analyser;
                    return true;
                } catch (e) {
                    alert("Microfoon toegang geweigerd.");
                    return false;
                }
            };

            const processAudio = () => {
                if (!analyserRef.current) return;
                const bufferLength = analyserRef.current.frequencyBinCount;
                const dataArray = new Float32Array(bufferLength);
                analyserRef.current.getFloatFrequencyData(dataArray);

                let minHz = 50, maxHz = 500;
                if (currentMode === 'bass') { minHz = 25; maxHz = 100; }
                if (currentMode === 'snare') { minHz = 150; maxHz = 600; }
                if (currentMode === 'toms') {
                    const size = kitSettings.tomSizes[selectedTomIdx];
                    minHz = size > 14 ? 40 : 80;
                    maxHz = size > 14 ? 180 : 400;
                }

                const sampleRate = audioContextRef.current.sampleRate;
                const binWidth = sampleRate / analyserRef.current.fftSize;
                const lowBin = Math.floor(minHz / binWidth);
                const highBin = Math.ceil(maxHz / binWidth);

                // Verbeterde Peak Detection met "Sub-harmonic suppression"
                // Dit voorkomt dat we de octaaf erboven (206 ipv 106) pakken.
                let bestFreq = 0;
                let maxMag = -Infinity;

                for (let i = lowBin; i < highBin; i++) {
                    let magnitude = dataArray[i];
                    
                    // Filter: check of er een sterke component is op de helft van deze frequentie (de echte grondtoon)
                    // Als we een piek vinden op 200Hz, kijken we of 100Hz ook aanwezig is.
                    // Zo ja, dan is 100Hz waarschijnlijk de grondtoon.
                    const halfIdx = Math.floor(i / 2);
                    if (halfIdx >= lowBin && dataArray[halfIdx] > -70) {
                        magnitude += dataArray[halfIdx] * 0.8; // Boost de lagere kandidaat
                    }

                    if (magnitude > maxMag) {
                        maxMag = magnitude;
                        bestFreq = i * binWidth;
                    }
                }

                // Noise floor drempel
                if (maxMag > -60 && (Date.now() - lastUpdateRef.current > 250)) {
                    // Parabolische interpolatie voor extra precisie
                    const binIdx = Math.round(bestFreq / binWidth);
                    if (binIdx > 0 && binIdx < bufferLength - 1) {
                        const y1 = dataArray[binIdx - 1];
                        const y2 = dataArray[binIdx];
                        const y3 = dataArray[binIdx + 1];
                        const d = (y3 - y1) / (2 * (2 * y2 - y1 - y3));
                        bestFreq = (binIdx + d) * binWidth;
                    }

                    setFrequency(bestFreq);
                    lastUpdateRef.current = Date.now();
                }
                animationRef.current = requestAnimationFrame(processAudio);
            };

            const toggleTuner = async () => {
                if (!isRunning) {
                    const success = await initAudio();
                    if (success) {
                        setIsRunning(true);
                        processAudio();
                    }
                } else {
                    setIsRunning(false);
                    cancelAnimationFrame(animationRef.current);
                }
            };

            const toggleTare = () => {
                if (tareValue === null) {
                    if (frequency > 0) setTareValue(frequency);
                } else {
                    setTareValue(null);
                }
            };

            const saveSettings = () => {
                const settingsToSave = { ...kitSettings, lang };
                localStorage.setItem('tuneinator_pro_v2_genres', JSON.stringify(settingsToSave));
                setView('tuner');
            };

            const handleNumTomsChange = (num) => {
                const newNum = parseInt(num);
                let newSizes = [...kitSettings.tomSizes];
                if (newNum > newSizes.length) {
                    while(newSizes.length < newNum) newSizes.push(16);
                } else {
                    newSizes = newSizes.slice(0, newNum);
                }
                setKitSettings({...kitSettings, numToms: newNum, tomSizes: newSizes});
            };

            const getTarget = (head) => {
                let base = 150;
                let genreModifier = 1.0;
                if (kitSettings.soundStyle === 'jazz') genreModifier = 1.25;
                if (kitSettings.soundStyle === 'fusion') genreModifier = 1.15;
                if (kitSettings.soundStyle === 'metal') genreModifier = 0.95;

                if (currentMode === 'snare') {
                    base = (220 + (kitSettings.snareTuning * 180)) * genreModifier;
                } else if (currentMode === 'bass') {
                    base = (55 + (kitSettings.bassSize < 22 ? 10 : 0)) * (genreModifier < 1 ? genreModifier : 1);
                } else if (currentMode === 'toms') {
                    const s = kitSettings.tomSizes[selectedTomIdx];
                    base = s === 10 ? 190 : s === 12 ? 155 : s === 14 ? 125 : 95;
                    base = base * genreModifier;
                }

                const ratio = 0.9 + (kitSettings.resoRatio * 0.2);
                return head === 'reso' ? (base * ratio).toFixed(0) : base.toFixed(0);
            };

            const displayFreq = tareValue !== null && frequency > 0 
                ? (frequency - tareValue).toFixed(1) 
                : frequency.toFixed(1);

            return (
                <div className="min-h-screen p-4 flex flex-col items-center select-none">
                    <div className="w-full max-w-md flex flex-col h-full">
                        
                        <header className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-black italic shadow-lg">Ti</div>
                                <div>
                                    <h1 className="text-lg font-black tracking-tight uppercase leading-none">DRUM TUNE-inator</h1>
                                    <p className="text-[9px] font-bold text-blue-500 uppercase tracking-widest leading-none mt-1">PRO ENGINE v2.5</p>
                                </div>
                            </div>
                            <button onClick={() => setView(view === 'tuner' ? 'settings' : 'tuner')} className="w-10 h-10 bg-white/5 rounded-xl border border-white/10 flex items-center justify-center active:scale-90 transition-all">
                                {view === 'tuner' ? '⚙️' : '✕'}
                            </button>
                        </header>

                        {view === 'tuner' ? (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                
                                <div className="flex justify-between gap-1 overflow-x-auto hide-scrollbar py-1">
                                    {['ROCK', 'METAL', 'JAZZ', 'FUSION'].map(style => (
                                        <button 
                                            key={style} 
                                            onClick={() => setKitSettings({...kitSettings, soundStyle: style.toLowerCase()})}
                                            className={`px-4 py-2 rounded-full text-[9px] font-black transition-all border ${kitSettings.soundStyle === style.toLowerCase() ? 'bg-white text-black border-white' : 'bg-transparent text-gray-500 border-white/10'}`}
                                        >
                                            {style}
                                        </button>
                                    ))}
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-dark-card p-4 rounded-3xl text-center shadow-inner">
                                        <p className="text-[8px] font-black text-gray-500 uppercase tracking-widest mb-1">{t.targetBatter}</p>
                                        <p className="text-3xl font-black text-blue-400">{getTarget('batter')}<span className="text-xs ml-1">Hz</span></p>
                                        <p className="text-[10px] font-bold text-gray-600 uppercase">{getNoteFromFreq(getTarget('batter'))}</p>
                                    </div>
                                    <div className="bg-dark-card p-4 rounded-3xl text-center shadow-inner">
                                        <p className="text-[8px] font-black text-gray-500 uppercase tracking-widest mb-1">{t.targetReso}</p>
                                        <p className="text-3xl font-black text-blue-400">{getTarget('reso')}<span className="text-xs ml-1">Hz</span></p>
                                        <p className="text-[10px] font-bold text-gray-600 uppercase">{getNoteFromFreq(getTarget('reso'))}</p>
                                    </div>
                                </div>

                                <div className="bg-dark-card rounded-[2.5rem] py-12 text-center border shadow-2xl relative overflow-hidden">
                                    {tareValue !== null && (
                                        <div className="absolute top-4 left-0 right-0 flex justify-center">
                                            <span className="bg-blue-600/20 text-blue-400 px-3 py-1 rounded-full text-[8px] font-bold tracking-widest uppercase border border-blue-600/30">
                                                Tare Ref: {tareValue.toFixed(1)} Hz
                                            </span>
                                        </div>
                                    )}
                                    <div className={`text-8xl font-black tracking-tighter tabular-nums leading-none ${tareValue !== null ? 'tare-active' : ''}`}>
                                        {frequency > 0 ? (tareValue !== null ? (frequency - tareValue >= 0 ? "+" : "") + displayFreq : displayFreq) : "0.0"}
                                    </div>
                                    <p className="text-gray-500 font-bold tracking-[0.4em] uppercase text-[10px] mt-4">
                                        {tareValue !== null ? "∆ DIFFERENTIAL HERTZ" : t.hertz}
                                    </p>
                                    <div className="mt-2 text-blue-500 font-black text-xl italic">{getNoteFromFreq(frequency)}</div>
                                </div>

                                <div className="grid grid-cols-3 gap-2">
                                    {['BASS', 'SNARE', 'TOMS'].map(m => (
                                        <button key={m} onClick={() => {setCurrentMode(m.toLowerCase()); setFrequency(0); setTareValue(null);}} className={`py-4 rounded-2xl text-[10px] font-black tracking-widest transition-all ${currentMode === m.toLowerCase() ? 'bg-blue-600 shadow-lg scale-105' : 'bg-dark-card text-gray-500'}`}>{m}</button>
                                    ))}
                                </div>

                                {currentMode === 'toms' && (
                                    <div className="flex justify-center gap-3 py-1 overflow-x-auto hide-scrollbar">
                                        {kitSettings.tomSizes.map((size, idx) => (
                                            <button key={idx} onClick={() => {setSelectedTomIdx(idx); setFrequency(0); setTareValue(null);}} className={`min-w-[56px] h-14 rounded-full border-2 flex flex-col items-center justify-center transition-all ${selectedTomIdx === idx ? 'bg-blue-600 border-white scale-110 shadow-xl' : 'bg-dark-card border-transparent text-gray-500'}`}>
                                                <span className="text-xs font-black">{size}"</span>
                                            </button>
                                        ))}
                                    </div>
                                )}

                                <div className="flex gap-3">
                                    <button onClick={toggleTuner} className={`flex-[2.5] py-6 rounded-[2rem] font-black text-2xl shadow-xl transition-all active:scale-95 ${isRunning ? 'bg-red-500 text-white' : 'bg-white text-black'}`}>
                                        {isRunning ? t.stop : t.start}
                                    </button>
                                    <button 
                                        onClick={toggleTare}
                                        disabled={!isRunning}
                                        className={`flex-1 rounded-[2rem] border flex flex-col items-center justify-center transition-all ${tareValue !== null ? 'bg-blue-600 border-white text-white' : 'bg-dark-card border-white/5 text-gray-500'} active:scale-90 disabled:opacity-30`}
                                    >
                                        <span className="text-[12px] font-black tracking-tighter leading-none">{tareValue !== null ? t.reset : t.tare}</span>
                                        <span className="text-[7px] mt-1 opacity-60">LUG DIFF</span>
                                    </button>
                                </div>

                                <div className="bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-2xl text-center">
                                    <p className="text-[9px] text-yellow-500 font-black tracking-widest uppercase">
                                        {t.instruction}
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-dark-card rounded-[2.5rem] p-6 space-y-6 animate-in slide-in-from-bottom duration-500 overflow-y-auto max-h-[80vh] hide-scrollbar pb-10">
                                <h2 className="text-xl font-black uppercase tracking-tight">{t.settings}</h2>
                                
                                <div className="bg-black/20 p-4 rounded-3xl space-y-3 border border-white/5">
                                    <p className="text-[10px] font-black text-gray-500 uppercase tracking-widest">{t.language}</p>
                                    <div className="flex bg-slate-900/50 p-1 rounded-xl">
                                        <button onClick={() => setLang('nl')} className={`flex-1 py-2 rounded-lg text-[10px] font-black transition-all ${lang === 'nl' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-500'}`}>NEDERLANDS</button>
                                        <button onClick={() => setLang('en')} className={`flex-1 py-2 rounded-lg text-[10px] font-black transition-all ${lang === 'en' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-500'}`}>ENGLISH</button>
                                    </div>
                                </div>

                                <div className="bg-black/20 p-5 rounded-3xl space-y-4 border border-white/5">
                                    <p className="text-[10px] font-black text-gray-500 uppercase tracking-widest">{t.snareTuning}</p>
                                    <input type="range" className="w-full" min="0" max="1" step="0.1" value={kitSettings.snareTuning} onChange={(e) => setKitSettings({...kitSettings, snareTuning: parseFloat(e.target.value)})} />
                                    <div className="flex justify-between text-[8px] font-bold text-gray-600 uppercase">
                                        <span>{t.deep}</span>
                                        <span>{t.tight}</span>
                                    </div>
                                </div>

                                <div className="bg-black/20 p-5 rounded-3xl space-y-4 border border-white/5">
                                    <p className="text-[10px] font-black text-gray-500 uppercase tracking-widest">{t.resonance}</p>
                                    <input type="range" className="w-full" min="0" max="1" step="0.1" value={kitSettings.resoRatio} onChange={(e) => setKitSettings({...kitSettings, resoRatio: parseFloat(e.target.value)})} />
                                    <div className="flex justify-between text-[8px] font-bold text-gray-600 uppercase">
                                        <span>{t.maxAttack}</span>
                                        <span>{t.maxSustain}</span>
                                    </div>
                                </div>

                                <div className="bg-black/20 p-5 rounded-3xl space-y-4 border border-white/5">
                                    <p className="text-[10px] font-black text-gray-500 uppercase tracking-widest">{t.tomConfig}</p>
                                    <div className="flex gap-2">
                                        {[1, 2, 3, 4, 5].map(n => (
                                            <button key={n} onClick={() => handleNumTomsChange(n)} className={`flex-1 py-2 rounded-lg font-black text-xs ${kitSettings.numToms === n ? 'bg-blue-600' : 'bg-white/5'}`}>{n}</button>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 mt-4">
                                        {kitSettings.tomSizes.map((size, idx) => (
                                            <div key={idx} className="flex flex-col">
                                                <label className="text-[8px] font-bold text-gray-600 uppercase mb-1">Tom {idx+1} (inch)</label>
                                                <input type="number" value={size} onChange={(e) => {
                                                        const newSizes = [...kitSettings.tomSizes];
                                                        newSizes[idx] = parseInt(e.target.value);
                                                        setKitSettings({...kitSettings, tomSizes: newSizes});
                                                    }} className="bg-white/5 border border-white/10 rounded-xl p-2 text-center font-black text-sm" />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <button onClick={saveSettings} className="w-full py-5 bg-white text-black rounded-[2rem] font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">{t.save}</button>
                            </div>
                        )}
                        <footer className="mt-auto py-6 text-center">
                            <p className="text-[9px] text-gray-600 font-bold tracking-[0.3em] uppercase opacity-50">DRUM TUNE-inator Professional Engine v2.5</p>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
